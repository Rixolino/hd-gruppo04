<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - HelpDigit</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body>

    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1>Gestione Ordini</h1>
                    <div>
                        <a href="/dashboard" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Dashboard
                        </a>
                    </div>
                </div>

                <% if (query && query.success) { %>
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <%= query.success %>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close"></button>
                    </div>
                <% } %>

                <% if (req.query.error) { %>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <%= req.query.error %>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                <% } %>

                <!-- Statistiche Dashboard -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card card-elevated text-center">
                            <div class="card-body">
                                <h5 class="card-title">Ordini totali</h5>
                                <h2 class="display-4">
                                    <%= stats.totalOrders || 0 %>
                                </h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-elevated text-center">
                            <div class="card-body">
                                <h5 class="card-title">In lavorazione</h5>
                                <h2 class="display-4">
                                    <%= stats.inProgressOrders || 0 %>
                                </h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-elevated text-center">
                            <div class="card-body">
                                <h5 class="card-title">Completati</h5>
                                <h2 class="display-4">
                                    <%= stats.completedOrders || 0 %>
                                </h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-elevated text-center">
                            <div class="card-body">
                                <h5 class="card-title">Ricavi totali</h5>
                                <h2 class="display-4">€<%= (stats.totalRevenue || 0).toFixed(2) %>
                                </h2>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtri -->
                <div class="card card-elevated mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Filtri</h5>
                        <form id="filter-form" class="row">
                            <div class="col-md-3 form-group">
                                <label for="filter-status">Stato</label>
                                <select id="filter-status" class="form-control">
                                    <option value="">Tutti gli stati</option>
                                    <option value="in-attesa">In attesa</option>
                                    <option value="pagamento-in-attesa">In attesa di pagamento</option>
                                    <option value="in-lavorazione">In lavorazione</option>
                                    <option value="in-revisione">In revisione</option>
                                    <option value="completato">Completato</option>
                                    <option value="consegnato">Consegnato</option>
                                </select>
                            </div>
                            <div class="col-md-3 form-group">
                                <label for="filter-service">Servizio</label>
                                <input type="text" id="filter-service" class="form-control"
                                    placeholder="Filtra per servizio">
                            </div>
                            <div class="col-md-3 form-group">
                                <label for="filter-user">Cliente</label>
                                <input type="text" id="filter-user" class="form-control"
                                    placeholder="Nome o email cliente">
                            </div>
                            <div class="col-md-3 form-group">
                                <label>&nbsp;</label>
                                <button type="button" id="apply-filters"
                                    class="btn btn-primary btn-block">
                                    <i class="fas fa-filter"></i> Applica filtri
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Tabella Ordini -->
                <div class="card card-elevated">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="orders-table" class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cliente</th>
                                        <th>Servizio</th>
                                        <th>Stato</th>
                                        <th>Prezzo</th>
                                        <th>Data Richiesta</th>
                                        <th>Progresso</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (orders && orders.length> 0) { %>
                                        <% orders.forEach(order=> { %>
                                            <tr class="order-row"
                                                data-status="<%= order.status || order.stato %>"
                                                data-service="<%= order.serviceName %>"
                                                data-user="<%= `${order.nome} ${order.cognome} ${order.email}`.toLowerCase() %>">
                                                <td>
                                                    <%= order.id %>
                                                </td>
                                                <td>
                                                    <div><strong>
                                                            <%= order.nome %>
                                                                <%= order.cognome %>
                                                        </strong></div>
                                                    <small class="text-muted">
                                                        <%= order.email %>
                                                    </small>
                                                </td>
                                                <td>
                                                    <%= order.serviceName %>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="colorblind-indicator mr-2"
                                                            data-mode="<%= user.colorBlindMode || 'none' %>">
                                                            <span
                                                                class="status-badge status-<%= order.status || order.stato %>"></span>
                                                        </div>
                                                        <%= order.status || order.stato %>
                                                    </div>
                                                </td>
                                                <td>€<%= parseFloat(order.prezzo).toFixed(2) %>
                                                </td>
                                                <td>
                                                    <%= new Date(order.dataRichiesta ||
                                                        order.createdAt).toLocaleDateString('it-IT') %>
                                                </td>
                                                <td>
                                                    <div class="progress" style="height: 20px;">
                                                        <div class="progress-bar" role="progressbar"
                                                            data-progress="<%= order.progressoLavoro %>"
                                                            aria-valuemin="0" aria-valuemax="100">
                                                            <%= order.progressoLavoro %>%
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="d-flex">
                                                        <button
                                                            class="btn btn-sm btn-primary mr-1 update-status-btn"
                                                            data-toggle="modal"
                                                            data-target="#updateStatusModal"
                                                            data-id="<%= order.id %>"
                                                            data-status="<%= order.status || order.stato %>"
                                                            data-progress="<%= order.progressoLavoro %>">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <a href="/orders/<%= order.id %>"
                                                            class="btn btn-sm btn-info mr-1"
                                                            target="_blank">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                            <% }); %>
                                                <% } else { %>
                                                    <tr>
                                                        <td colspan="8" class="text-center">Nessun
                                                            ordine trovato</td>
                                                    </tr>
                                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Update Status -->
    <div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateStatusModalLabel">Aggiorna stato ordine</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="update-status-form" method="POST">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="status">Stato</label>
                            <select class="form-control" id="status" name="status" required>
                                <option value="in-attesa">In attesa</option>
                                <option value="pagamento-in-attesa">In attesa di pagamento</option>
                                <option value="in-lavorazione">In lavorazione</option>
                                <option value="in-revisione">In revisione</option>
                                <option value="completato">Completato</option>
                                <option value="consegnato">Consegnato</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="progressoLavoro">Progresso (%)</label>
                            <input type="range" class="custom-range" id="progressoLavoro" name="progressoLavoro" min="0"
                                max="100" step="5">
                            <div class="d-flex justify-content-between">
                                <span>0%</span>
                                <span id="progressValue">0%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Annulla</button>
                        <button type="submit" class="btn btn-primary">Salva</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Gestione aggiornamento stato ordine
            const updateStatusBtns = document.querySelectorAll('.update-status-btn');
            const updateStatusForm = document.getElementById('update-status-form');
            const progressRange = document.getElementById('progressoLavoro');
            const progressValue = document.getElementById('progressValue');

            // Aggiorna valore progresso
            progressRange.addEventListener('input', function () {
                progressValue.textContent = this.value + '%';
            });

            updateStatusBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    const orderId = this.dataset.id;
                    const status = this.dataset.status;
                    const progress = this.dataset.progress;

                    // Imposta i valori nel form
                    document.getElementById('status').value = status;
                    document.getElementById('progressoLavoro').value = progress;
                    progressValue.textContent = progress + '%';

                    // Aggiorna l'action del form
                    updateStatusForm.action = `/admin/orders/${orderId}/update-status`;
                });
            });

            // Gestione filtri
            const applyFiltersBtn = document.getElementById('apply-filters');
            const filterStatus = document.getElementById('filter-status');
            const filterService = document.getElementById('filter-service');
            const filterUser = document.getElementById('filter-user');
            const orderRows = document.querySelectorAll('.order-row');

            applyFiltersBtn.addEventListener('click', function () {
                const statusFilter = filterStatus.value.toLowerCase();
                const serviceFilter = filterService.value.toLowerCase();
                const userFilter = filterUser.value.toLowerCase();

                orderRows.forEach(row => {
                    const rowStatus = row.dataset.status.toLowerCase();
                    const rowService = row.dataset.service.toLowerCase();
                    const rowUser = row.dataset.user.toLowerCase();

                    const matchStatus = !statusFilter || rowStatus === statusFilter;
                    const matchService = !serviceFilter || rowService.includes(serviceFilter);
                    const matchUser = !userFilter || rowUser.includes(userFilter);

                    if (matchStatus && matchService && matchUser) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        });
    </script>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
    <script src="/js/build.js"></script>
</body>

</html>